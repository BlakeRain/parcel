<form id="upload-list-container">
  <div class="flex flex-col border border-slate-400 dark:border-gray-700 dark:bg-gray-800 rounded-md shadow-md">
    <div class="flex flex-row justify-between p-4">
      <h1 class="text-4xl font-bold">
        Your uploads{% if total > 0 %} ({{ total }}){% endif %}
      </h1>
      <div class="buttons">
        <button
          id="delete_selected"
          type="button"
          class="button order-2 sm:order-1"
          hx-trigger="click"
          hx-delete="/uploads/list"
          hx-target="#upload-list-container"
          hx-select="#upload-list-container"
          hx-confirm="Are you sure you want to delete the selected files?"
          hx-swap="outerHTML"
          disabled>
          <span class="icon-trash-2"></span>
          Delete
        </button>
        <button
          id="upload-list-refresh"
          type="button"
          class="button order-1 sm:order-2"
          hx-trigger="click,refresh"
          hx-push="/?order={{ query.order }}&asc={{ query.asc }}&page={{ query.page }}"
          hx-get="/uploads/list?order={{ query.order }}&asc={{ query.asc }}&page={{ query.page }}"
          hx-target="#upload-list-container"
          hx-select="#upload-list-container"
          hx-swap="outerHTML"
          hx-on::before-request="htmx.trigger('#upload-stats-container', 'refresh')">
          <span class="icon-refresh-cw"></span>
          Refresh
        </button>
      </div>
    </div>
    <div class="table">
      <table>
        <thead>
          <tr>
            <th class="slim">
              <parcel-checkbox-group id="uploads_group" name="uploads">
              </parcel-checkbox-group>
            </th>
            {% macro sort_heading(query, name, align, title) %}
              {% set qs = "order=" + name %}
              {% if query.order == name %}
                {% set qs = qs + "&asc=" + ("false" if query.asc else "true") %}
              {% else %}
                {% set qs = qs + "&asc=true" %}
              {% endif %}
              {% set qs = qs + "&page=" + (query.page | safe) %}
              <th
                class="text-nowrap text-{{ align }} cursor-pointer"
                hx-get="/uploads/list?{{ qs }}"
                hx-push-url="/?{{ qs }}"
                hx-trigger="click"
                hx-target="#upload-list-container"
                hx-select="#upload-list-container"
                hx-swap="outerHTML">
                {{ title }}
                {% if query.order == name %}
                  {% if query.asc %}
                    <span class="icon-chevron-up"></span>
                  {% else %}
                    <span class="icon-chevron-down"></span>
                  {% endif %}
                {% else %}
                  <span class="icon-chevrons-up-down"></span>
                {% endif %}
              </th>
            {% endmacro %}
            {{ sort_heading(query, "filename", "left", "File") }}
            {{ sort_heading(query, "size", "right", "Size") }}
            {{ sort_heading(query, "downloads", "right", "Downloads") }}
            <th class="text-nowrap text-right">Remaining</th>
            {{ sort_heading(query, "expiry_date", "left", "Expires") }}
            <th>Public</th>
            {{ sort_heading(query, "uploaded_at", "left", "Uploaded") }}
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% if uploads | length == 0 %}
          <tr>
            <td colspan="9" class="text-center italic">
              Nothing to show
            </td>
          </tr>
          {% endif %}
          {% for upload in uploads %}
            <tr>
              <td class="slim text-center">
                <parcel-grouped-checkbox
                  name="selected"
                  group="uploads"
                  value="{{ upload.id }}">
                </parcel-grouped-checkbox>
              </td>
              <td>
                <div class="flex flex-row gap-1">
                  <a class="text-nowrap" href="/uploads/{{ upload.slug }}">{{ upload.filename }}</a>
                  <parcel-clipboard url="true" value="/uploads/{{ upload.slug }}"></parcel-clipboard>
                </div>
              </td>
              <td class="text-right text-nowrap">{{ upload.size | filesizeformat }}</td>
              <td class="text-right text-nowrap">{{ upload.downloads }}</td>
              <td class="text-right text-nowrap {% if upload.remaining is number and upload.remaining == 0 %}text-danger{% endif %}">
                {% if upload.limit is number %}
                  {% if upload.remaining is number and upload.remaining < upload.limit %}
                    <a
                      href="#"
                      hx-post="/uploads/{{ upload.id }}/reset"
                      hx-trigger="click"
                      hx-target="closest td"
                      hx-swap="outerHTML"
                      hx-confirm="Are you sure you want to reset the download counter for this upload?">
                      <span class="icon-rotate-ccw"></span>
                    </a>
                  {% endif %}
                  {{ upload.remaining | default(value = upload.limit) }} / {{ upload.limit }}
                {% else %}
                  <i>Unlimited</i>
                {% endif %}
              </td>
              <td class="text-nowrap">
                {% if upload.expiry_date %}
                  <parcel-date value="{{ upload.expiry_date | datetime }}">
                    {{ upload.expiry_date | datetime }}
                  </parcel-date>
                  ({{ upload.expiry_date | datetime_offset }})
                {% else %}
                  <i>Never</i>
                {% endif %}
              </td>
              {% if upload.public %}
                <td class="text-center text-danger">Yes</td>
              {% else %}
                <td class="text-center text-success">No</td>
              {% endif %}
              <td class="text-left text-nowrap">
                <parcel-datetime value="{{ upload.uploaded_at | datetime }}">
                  {{ upload.uploaded_at | datetime }}
                </parcel-datetime>
              </td>
              <td class="text-right whitespace-nowrap">
                <a href="/uploads/{{ upload.slug }}/download" title="Download {{ upload.filename }}">
                  <span class="icon-download"></span>
                </a>
                <a
                  href="#"
                  title="Edit upload settings"
                  hx-get="/uploads/{{ upload.id }}/edit"
                  hx-trigger="click"
                  hx-target="body"
                  hx-swap="beforeend">
                  <span class="icon-pencil"></span>
                </a>
                <a
                  href="#"
                  title="Delete upload"
                  hx-delete="/uploads/{{ upload.id }}"
                  hx-trigger="click"
                  hx-target="closest tr"
                  hx-swap="outerHTML swap:0.5s"
                  hx-confirm="Are you sure you want to delete this upload?">
                  <span class="icon-trash-2"></span>
                </a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% if total > 100 %}
      <div class="flex flex-row justify-center gap-2 mb-4">
        <button
          type="button"
          class="button hollow"
          {% if query.page == 0 %}
            disabled
          {% else %}
            hx-push="/?order={{ query.order }}&asc={{ query.asc }}&page={{ query.page - 1 }}"
            hx-get="/uploads/list?order={{ query.order }}&asc={{ query.asc }}&page={{ query.page - 1 }}"
            hx-target="#upload-list-container"
            hx-select="#upload-list-container"
            hx-swap="outerHTML"
            hx-on::before-request="htmx.trigger('#upload-stats-container', 'refresh')"
          {% endif %}>
          <span class="icon-chevron-left"></span>
          Previous page
        </button>

        {% for page in pages %}
          <button
            type="button"
            class="button hollow"
            {% if page == query.page %}
              disabled
            {% else %}
              hx-push="/?order={{ query.order }}&asc={{ query.asc }}&page={{ page }}"
              hx-get="/uploads/list?order={{ query.order }}&asc={{ query.asc }}&page={{ page }}"
              hx-target="#upload-list-container"
              hx-select="#upload-list-container"
              hx-swap="outerHTML"
              hx-on::before-request="htmx.trigger('#upload-stats-container', 'refresh')"
            {% endif %}>
            {{ page + 1 }}
          </button>
        {% endfor %}

        <button
          type="button"
          class="button hollow"
          {% if query.page == (pages | length - 1) %}
            disabled
          {% else %}
            hx-push="/?order={{ query.order }}&asc={{ query.asc }}&page={{ query.page + 1 }}"
            hx-get="/uploads/list?order={{ query.order }}&asc={{ query.asc }}&page={{ query.page + 1 }}"
            hx-target="#upload-list-container"
            hx-select="#upload-list-container"
            hx-swap="outerHTML"
            hx-on::before-request="htmx.trigger('#upload-stats-container', 'refresh')"
          {% endif %}>
          <span class="icon-chevron-right"></span>
          Next page
        </button>
      </div>
    {% endif %}
  </div>
</div>

<script>
  (function() {
    document.getElementById("uploads_group").addEventListener("changed", (event) => {
      document.getElementById("delete_selected").disabled = !event.detail.any;
    });
  })();
</script>
